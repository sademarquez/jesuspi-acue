document.addEventListener('DOMContentLoaded', function () {
    // --- Elementos del DOM ---
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const closeMobileMenuButton = document.getElementById('close-mobile-menu-button');
    const header = document.getElementById('main-header');
    const sections = document.querySelectorAll('main section');
    const navLinks = document.querySelectorAll('.nav-link'); // Todos los enlaces de navegación
    const contentGrid = document.getElementById('content-grid');
    const filterButtons = document.querySelectorAll('.filter-btn');

    // --- Carrusel (Trayectoria) ---
    const carouselTrack = document.getElementById('carousel-track');
    const carouselPrev = document.getElementById('carousel-prev');
    const carouselNext = document.getElementById('carousel-next');
    const carouselDotsContainer = document.getElementById('carousel-dots');
    let currentIndex = 0;
    let autoSlideInterval;
    let startX = 0;

    // Datos del carrusel: Se cargarán desde timeline-data.json
    let carouselContentData = [];

    // --- Funciones del Carrusel ---
    function initializeCarousel() {
        if (!carouselTrack || !carouselDotsContainer || carouselContentData.length === 0) {
            console.warn("No se pudo inicializar el carrusel: elementos DOM no encontrados o datos vacíos.");
            return;
        }
        renderCarouselItems();
        renderDots();
        showSlide(currentIndex);
        startAutoSlide();

        carouselPrev.addEventListener('click', () => {
            prevSlide();
            stopAutoSlide();
            startAutoSlide();
        });
        carouselNext.addEventListener('click', () => {
            nextSlide();
            stopAutoSlide();
            startAutoSlide();
        });

        // Touch events for carousel (swipe)
        carouselTrack.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            stopAutoSlide();
        });

        carouselTrack.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const diffX = startX - endX;

            if (Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    nextSlide();
                } else {
                    prevSlide();
                }
            }
            startAutoSlide();
        });
    }

    function renderCarouselItems() {
        carouselTrack.innerHTML = '';
        carouselContentData.forEach(item => {
            const carouselItem = document.createElement('div');
            carouselItem.className = 'w-full flex-shrink-0 p-4';
            carouselItem.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg mx-auto">
                    <img src="images/${item.image}" alt="${item.title}" class="w-full h-auto rounded-md mb-4">
                    <h3 class="text-2xl font-semibold text-primary-red mb-2">${item.title}</h3>
                    <p class="text-deep-charcoal">${item.description}</p>
                    <span class="block mt-4 text-lg font-bold text-primary-red">${item.year}</span>
                </div>
            `;
            carouselTrack.appendChild(carouselItem);
        });
    }

    function showSlide(index) {
        if (carouselContentData.length === 0) return;

        if (index < 0) {
            currentIndex = carouselContentData.length - 1;
        } else if (index >= carouselContentData.length) {
            currentIndex = 0;
        } else {
            currentIndex = index;
        }

        const offset = -currentIndex * 100;
        carouselTrack.style.transform = `translateX(${offset}%)`;
        updateDots();
    }

    function goToSlide(index) {
        showSlide(index);
        stopAutoSlide();
        startAutoSlide();
    }

    function nextSlide() {
        showSlide(currentIndex + 1);
    }

    function prevSlide() {
        showSlide(currentIndex - 1);
    }

    function startAutoSlide() {
        stopAutoSlide();
        autoSlideInterval = setInterval(nextSlide, 5000);
    }

    function stopAutoSlide() {
        clearInterval(autoSlideInterval);
    }

    function renderDots() {
        carouselDotsContainer.innerHTML = '';
        carouselDotsContainer.classList.add('carousel-dots');
        carouselContentData.forEach((_, index) => {
            const dot = document.createElement('span');
            dot.className = 'dot w-3 h-3 rounded-full cursor-pointer opacity-50'; // Color se define en CSS
            dot.addEventListener('click', () => goToSlide(index));
            carouselDotsContainer.appendChild(dot);
        });
        updateDots();
    }

    function updateDots() {
        document.querySelectorAll('#carousel-dots .dot').forEach((dot, index) => {
            if (index === currentIndex) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    }

    // --- Funciones del Menú Móvil ---
    function openMobileMenu() {
        document.body.style.overflow = 'hidden';
        mobileMenu.classList.add('active');
    }

    function closeMobileMenu() {
        document.body.style.overflow = '';
        mobileMenu.classList.remove('active');
    }

    function toggleMobileMenu() {
        if (mobileMenu.classList.contains('active')) {
            closeMobileMenu();
        } else {
            openMobileMenu();
        }
    }

    // --- Event Listeners Generales ---
    if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', toggleMobileMenu);
    }

    if (closeMobileMenuButton) {
        closeMobileMenuButton.addEventListener('click', closeMobileMenu);
    }

    document.querySelectorAll('#mobile-menu .nav-link').forEach(link => {
        link.addEventListener('click', closeMobileMenu);
    });

    window.addEventListener('resize', function() {
        if (window.innerWidth >= 768) {
            if (mobileMenu.classList.contains('active')) {
                closeMobileMenu();
            }
        }
    });

    // --- Lógica de filtrado de contenido (Pensamiento y Acción) ---
    let contentData = [];

    function filterContent(category) {
        if (!contentGrid || !contentData.length) {
            console.warn("No se pudo filtrar el contenido: elemento DOM no encontrado o datos vacíos.");
            return;
        }

        contentGrid.innerHTML = '';

        const filtered = category === 'todos' ? contentData : contentData.filter(item => item.category === category);

        if (filtered.length === 0) {
            contentGrid.innerHTML = '<p class="text-center text-lg text-deep-charcoal col-span-full">No hay contenido disponible para esta categoría.</p>';
            return;
        }

        filtered.forEach(item => {
            const contentItem = document.createElement('div');
            contentItem.className = 'bg-white rounded-lg shadow-lg overflow-hidden'; // Clases base para la tarjeta
            contentItem.innerHTML = `
                <img src="images/${item.image}" alt="${item.title}" class="w-full h-48 object-cover">
                <div class="p-6">
                    <h3 class="text-2xl font-semibold text-primary-red mb-2">${item.title}</h3>
                    <p class="text-deep-charcoal mb-4">${item.description}</p>
                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="inline-block button button-primary px-4 py-2 rounded-full">Leer más</a>
                </div>
            `;
            contentGrid.appendChild(contentItem);
        });

        // Actualiza el estado activo de los botones de filtro
        filterButtons.forEach(button => {
            if (button.dataset.filter === category) {
                button.classList.add('button-primary'); // Aplica estilo primario
                button.classList.remove('button-secondary'); // Remueve estilo secundario
            } else {
                button.classList.remove('button-primary'); // Remueve estilo primario
                button.classList.add('button-secondary'); // Aplica estilo secundario
            }
        });
    }

    // --- Función para el desplazamiento suave para enlaces de anclaje ---
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                const headerHeight = header ? header.offsetHeight : 0;
                window.scrollTo({
                    top: targetElement.offsetTop - headerHeight,
                    behavior: 'smooth'
                });
            }
            if (mobileMenu && mobileMenu.classList.contains('active')) {
                closeMobileMenu();
            }
        });
    });

    // --- Manejo de la clase 'active' para los enlaces de navegación al hacer scroll ---
    const updateActiveNavLink = () => {
        const headerHeight = header ? header.offsetHeight : 0;
        let currentActiveSectionId = '';

        sections.forEach(section => {
            // Ajusta el valor de offset para que la sección se active un poco antes o después
            const offset = 100; // Puedes ajustar este valor
            const sectionTop = section.offsetTop - headerHeight - offset;
            const sectionBottom = sectionTop + section.offsetHeight;

            if (window.scrollY >= sectionTop && window.scrollY < sectionBottom) {
                currentActiveSectionId = section.id;
            }
        });

        navLinks.forEach(link => {
            const href = link.getAttribute('href').substring(1);
            if (href === currentActiveSectionId) {
                link.classList.add('active'); // La clase 'active' se define en CSS para ambos menús
            } else {
                link.classList.remove('active');
            }
        });
    };

    window.addEventListener('scroll', updateActiveNavLink);
    updateActiveNavLink(); // Llamada inicial al cargar

    // --- Carga de datos del carrusel ---
    fetch('timeline-data.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} al cargar timeline-data.json`);
            }
            return response.json();
        })
        .then(data => {
            carouselContentData = data;
            initializeCarousel();
        })
        .catch(error => console.error('Error al cargar los datos de la línea de tiempo:', error));

    // --- Carga de datos del contenido (Pensamiento y Acción) ---
    fetch('content.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} al cargar content.json`);
            }
            return response.json();
        })
        .then(data => {
            contentData = data;
            filterContent('todos');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterContent(button.dataset.filter);
                });
            });
        })
        .catch(error => console.error('Error al cargar el contenido para Pensamiento y Acción:', error));
});
