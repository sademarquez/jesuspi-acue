document.addEventListener('DOMContentLoaded', function () {
    // --- Elementos del DOM ---
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const header = document.getElementById('main-header');
    const sections = document.querySelectorAll('main section');
    const navLinks = document.querySelectorAll('.nav-link'); // All nav links, both desktop and mobile
    const contentGrid = document.getElementById('content-grid');
    const filterButtons = document.querySelectorAll('.filter-btn');

    // --- Carrusel (Trayectoria) ---
    const carouselTrack = document.getElementById('carousel-track');
    const carouselPrev = document.getElementById('carousel-prev');
    const carouselNext = document.getElementById('carousel-next');
    const carouselDotsContainer = document.getElementById('carousel-dots');
    let currentIndex = 0;
    let autoSlideInterval;
    let startX = 0; // Para el swipe en móviles
    let currentTranslate = 0; // Para el seguimiento del arrastre (no usado actualmente, pero mantenido)

    // Datos del carrusel: Ahora se cargarán desde timeline-data.json
    let carouselContentData = [];

    // --- Funciones del Carrusel ---
    function initializeCarousel() {
        if (!carouselTrack || !carouselDotsContainer || carouselContentData.length === 0) {
            console.warn("No se pudo inicializar el carrusel: elementos DOM no encontrados o datos vacíos.");
            return;
        }
        renderCarouselItems();
        renderDots();
        showSlide(currentIndex);
        startAutoSlide();

        carouselPrev.addEventListener('click', prevSlide);
        carouselNext.addEventListener('click', nextSlide);

        // Touch events for carousel
        carouselTrack.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            // Optionally stop auto-slide on touch
            stopAutoSlide();
        });

        carouselTrack.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const diffX = startX - endX;

            if (Math.abs(diffX) > 50) { // Threshold for a swipe
                if (diffX > 0) { // Swipe left, go to next
                    nextSlide();
                } else { // Swipe right, go to previous
                    prevSlide();
                }
            }
            // Restart auto-slide after a brief delay
            startAutoSlide();
        });
    }

    function renderCarouselItems() {
        carouselTrack.innerHTML = ''; // Clear existing items
        carouselContentData.forEach(item => {
            const carouselItem = document.createElement('div');
            carouselItem.className = 'w-full flex-shrink-0 p-4';
            carouselItem.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg mx-auto">
                    <img src="${item.image}" alt="${item.title}" class="w-full h-auto rounded-md mb-4">
                    <h3 class="text-2xl font-semibold text-dark-gold mb-2">${item.title}</h3>
                    <p class="text-deep-charcoal">${item.description}</p>
                    <span class="block mt-4 text-lg font-bold text-dark-gold">${item.year}</span>
                </div>
            `;
            carouselTrack.appendChild(carouselItem);
        });
    }

    function showSlide(index) {
        if (index < 0) {
            currentIndex = carouselContentData.length - 1;
        } else if (index >= carouselContentData.length) {
            currentIndex = 0;
        } else {
            currentIndex = index;
        }

        const offset = -currentIndex * 100;
        carouselTrack.style.transform = `translateX(${offset}%)`;
        updateDots();
    }

    function goToSlide(index) {
        showSlide(index);
        stopAutoSlide();
        startAutoSlide();
    }

    function nextSlide() {
        showSlide(currentIndex + 1);
    }

    function prevSlide() {
        showSlide(currentIndex - 1);
    }

    function startAutoSlide() {
        stopAutoSlide(); // Clear any existing interval
        autoSlideInterval = setInterval(nextSlide, 5000); // Change slide every 5 seconds
    }

    function stopAutoSlide() {
        clearInterval(autoSlideInterval);
    }

    function renderDots() {
        carouselDotsContainer.innerHTML = '';
        carouselContentData.forEach((_, index) => {
            const dot = document.createElement('span');
            dot.className = 'dot w-3 h-3 bg-deep-charcoal rounded-full cursor-pointer opacity-50';
            if (index === currentIndex) {
                dot.classList.add('active');
            }
            dot.addEventListener('click', () => goToSlide(index));
            carouselDotsContainer.appendChild(dot);
        });
    }

    function updateDots() {
        document.querySelectorAll('.dot').forEach((dot, index) => {
            if (index === currentIndex) {
                dot.classList.add('active');
                dot.style.opacity = '1'; // Make active dot fully opaque
            } else {
                dot.classList.remove('active');
                dot.style.opacity = '0.5'; // Make inactive dots semi-transparent
            }
        });
    }

    // --- Funciones del Menú Móvil ---
    function openMobileMenu() {
        mobileMenu.classList.add('active');
    }

    function closeMobileMenu() {
        mobileMenu.classList.remove('active');
    }

    function toggleMobileMenu() {
        mobileMenu.classList.toggle('active');
    }

    // --- Event Listeners Generales ---
    if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', toggleMobileMenu);
    }

    // NEW: Add event listener to close mobile menu when a nav link inside it is clicked
    document.querySelectorAll('#mobile-menu .nav-link').forEach(link => {
        link.addEventListener('click', closeMobileMenu);
    });

    // NEW: Event listener for window resize to close mobile menu on desktop view
    window.addEventListener('resize', function() {
        // Check if the viewport width is greater than or equal to the md breakpoint (768px)
        // This should match your Tailwind CSS breakpoint configuration.
        if (window.innerWidth >= 768) {
            if (mobileMenu.classList.contains('active')) {
                closeMobileMenu();
            }
        }
    });

    // --- Lógica de filtrado de contenido (Pensamiento y Acción) ---
    let contentData = []; // Declarar contentData aquí para que sea accesible globalmente en el scope de DOMContentLoaded

    function filterContent(category) {
        if (!contentGrid || !contentData.length) {
            console.warn("No se pudo filtrar el contenido: elemento DOM no encontrado o datos vacíos.");
            return;
        }

        contentGrid.innerHTML = ''; // Limpiar contenido existente

        const filtered = category === 'todos' ? contentData : contentData.filter(item => item.category === category);

        if (filtered.length === 0) {
            contentGrid.innerHTML = '<p class="text-center text-lg text-deep-charcoal col-span-full">No hay contenido disponible para esta categoría.</p>';
            return;
        }

        filtered.forEach(item => {
            const contentItem = document.createElement('div');
            contentItem.className = 'bg-white rounded-lg shadow-lg overflow-hidden';
            contentItem.innerHTML = `
                <img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover">
                <div class="p-6">
                    <h3 class="text-2xl font-semibold text-dark-gold mb-2">${item.title}</h3>
                    <p class="text-deep-charcoal mb-4">${item.description}</p>
                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="inline-block bg-dark-gold text-deep-charcoal px-4 py-2 rounded-full hover:bg-muted-gold transition-colors">Leer más</a>
                </div>
            `;
            contentGrid.appendChild(contentItem);
        });

        // Update active state of filter buttons
        filterButtons.forEach(button => {
            if (button.dataset.filter === category) {
                button.classList.add('bg-dark-gold');
                button.classList.remove('bg-deep-charcoal');
            } else {
                button.classList.remove('bg-dark-gold');
                button.classList.add('bg-deep-charcoal');
            }
        });
    }

    // --- Función para el desplazamiento suave para enlaces de anclaje ---
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                const headerHeight = header ? header.offsetHeight : 0;
                window.scrollTo({
                    top: targetElement.offsetTop - headerHeight,
                    behavior: 'smooth'
                });
            }
            // This part already handles closing the mobile menu if the clicked link is within it
            // It's still good to keep as a general fallback, but the specific listener above is more direct.
            if (mobileMenu && mobileMenu.contains(this)) {
                closeMobileMenu();
            }
        });
    });

    // --- Manejo de la clase 'active' para los enlaces de navegación al hacer scroll ---
    const updateActiveNavLink = () => {
        const headerHeight = header ? header.offsetHeight : 0;
        let currentActiveSectionId = '';

        sections.forEach(section => {
            const sectionTop = section.offsetTop - headerHeight - 1; // -1 to ensure it activates slightly before it's fully covered
            const sectionBottom = sectionTop + section.offsetHeight;

            if (window.scrollY >= sectionTop && window.scrollY < sectionBottom) {
                currentActiveSectionId = section.id;
            }
        });

        // Add 'active' class to desktop nav links
        document.querySelectorAll('#desktop-nav .nav-link').forEach(link => {
            const href = link.getAttribute('href').substring(1);
            if (href === currentActiveSectionId) {
                link.classList.add('text-dark-gold');
                link.classList.remove('text-deep-charcoal');
            } else {
                link.classList.remove('text-dark-gold');
                link.classList.add('text-deep-charcoal');
            }
        });

        // Add 'active' class to mobile nav links (if applicable, using similar logic or specific style)
        document.querySelectorAll('#mobile-menu .nav-link').forEach(link => {
            const href = link.getAttribute('href').substring(1);
            if (href === currentActiveSectionId) {
                link.classList.add('text-dark-gold'); // Or any other active class for mobile menu
                link.classList.remove('text-soft-cream');
            } else {
                link.classList.remove('text-dark-gold');
                link.classList.add('text-soft-cream');
            }
        });
    };

    window.addEventListener('scroll', updateActiveNavLink);
    // Initial call to set active link on load
    updateActiveNavLink();


    // --- Carga de datos del carrusel ---
    fetch('timeline-data.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            carouselContentData = data;
            initializeCarousel();
        })
        .catch(error => console.error('Error al cargar los datos de la línea de tiempo:', error));

    // --- Carga de datos del contenido (Pensamiento y Acción) ---
    fetch('content.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            contentData = data;
            filterContent('todos'); // Muestra todo al cargar
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterContent(button.dataset.filter);
                });
            });
        })
        .catch(error => console.error('Error al cargar el contenido para Pensamiento y Acción:', error));
});
