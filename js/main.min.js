document.addEventListener('DOMContentLoaded', function () {
    // --- Elementos del DOM ---
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const header = document.getElementById('main-header');
    const sections = document.querySelectorAll('main section');
    const navLinks = document.querySelectorAll('.nav-link');
    const contentGrid = document.getElementById('content-grid');
    const filterButtons = document.querySelectorAll('.filter-btn');

    // --- Carrusel (Trayectoria) ---
    const carouselTrack = document.getElementById('carousel-track');
    const carouselPrev = document.getElementById('carousel-prev');
    const carouselNext = document.getElementById('carousel-next');
    const carouselDotsContainer = document.getElementById('carousel-dots');
    let currentIndex = 0;
    let autoSlideInterval;
    let startX = 0; // Para el swipe en móviles

    // Datos del carrusel (pueden venir de content.json si lo deseas, pero aquí por simplicidad)
    const carouselContentData = [
        { title: "Nacimiento", description: "Viene al mundo en el seno del pueblo Nasa, en el Cauca.", year: "1980", image: "timeline-1980.jpg" },
        { title: "Activismo Juvenil", description: "Inicia su participación en movimientos estudiantiles y comunitarios, forjando su liderazgo.", year: "1990s", image: "timeline-1990s.jpg" },
        { title: "Liderazgo Comunitario", description: "Asume roles importantes en su comunidad, promoviendo la autonomía y el desarrollo.", year: "2000s", image: "timeline-2000s.jpg" },
        { title: "Incidencia Política Nacional", description: "Participa en foros y mesas de diálogo nacionales, defendiendo los derechos indígenas.", year: "2010s", image: "timeline-2010s.jpg" },
        { title: "Actualidad", description: "Continúa su incansable labor por la equidad, la interculturalidad y la justicia social en Colombia.", year: "Hoy", image: "timeline-actualidad.jpg" }
    ];

    // --- Funciones del Menú Móvil ---
    if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        document.querySelectorAll('#mobile-menu a').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.add('hidden'); // Cierra el menú al hacer clic en un enlace
            });
        });
    }

    // --- Efecto de Sombra en Header al hacer Scroll ---
    if (header) {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                header.classList.add('shadow-lg');
            } else {
                header.classList.remove('shadow-lg');
            }
        });
    }

    // --- Observador para animaciones de sección y navegación activa ---
    const observerOptions = {
        root: null, // Observa el viewport
        rootMargin: '0px',
        threshold: 0.1 // La sección es visible al 10% (aparición casi inmediata)
    };

    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible'); // Añadir clase 'visible' para animación de entrada

                // Actualizar enlace de navegación activo
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href').substring(1) === entry.target.id) {
                        link.classList.add('active');
                    }
                });
            } else {
                // Comentado para que las secciones se queden visibles una vez animadas
                // entry.target.classList.remove('visible'); 
            }
        });
    }, observerOptions);

    sections.forEach(section => {
        sectionObserver.observe(section);
        // Activar la animación si la sección ya está en el viewport al cargar la página
        if (section.getBoundingClientRect().top < window.innerHeight) {
            section.classList.add('visible');
        }
    });

    // --- Carga dinámica de contenido 'Pensamiento y Acción' y Lazy Loading ---
    let allContentData = []; // Para almacenar todos los datos cargados una vez

    if (contentGrid) {
        fetch('content.json') // Ruta correcta asumida: 'content.json' en la raíz
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                allContentData = data; // Guarda todos los datos
                loadContent(data); // Carga el contenido inicial
            })
            .catch(error => {
                console.error('Error al cargar el contenido:', error);
                contentGrid.innerHTML = '<p class="text-center text-red-500">No se pudo cargar el contenido. Por favor, inténtalo de nuevo más tarde.</p>';
            });
    }

    function loadContent(dataToDisplay) {
        contentGrid.innerHTML = ''; // Limpiar grid
        const fragment = document.createDocumentFragment();

        dataToDisplay.forEach((item, index) => { // Añadimos 'index' para el delay escalonado
            const card = document.createElement('div');
            card.className = `content-card ${item.category}`; // Clases para animación y filtro
            card.setAttribute('data-category', item.category);
            card.style.setProperty('--delay', `${index * 0.08}s`); // Retraso escalonado de 80ms

            card.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden h-full flex flex-col">
                    <img data-src="images/${item.image}" 
                         onerror="this.onerror=null;this.src='https://via.placeholder.com/600x400.png?text=Imagen+no+disponible';this.alt='Imagen no disponible';" 
                         alt="Imagen representativa de un ${item.category}" 
                         class="w-full h-48 object-cover lazyload">
                    <div class="p-6 flex-grow flex flex-col justify-between">
                        <div>
                            <span class="inline-block bg-muted-gold text-dark-gold text-xs font-semibold px-3 py-1 rounded-full mb-2">${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</span>
                            <h3 class="text-xl font-bold mb-2 text-deep-charcoal">${item.title}</h3>
                            <p class="text-deep-charcoal text-base mb-4">${item.description}</p>
                        </div>
                        <a href="${item.link}" class="inline-block text-dark-gold font-semibold hover:underline mt-auto">Leer Más &rarr;</a>
                    </div>
                </div>
            `;
            fragment.appendChild(card);
        });

        contentGrid.appendChild(fragment);

        // Observador para Lazy Loading de las tarjetas de contenido
        const contentCardObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target.querySelector('img.lazyload');
                    if (img && img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazyload');
                        img.removeAttribute('data-src');
                    }
                    // Asegura que las tarjetas se animen cuando se hacen visibles
                    // La clase 'visible' se añade al #pensamiento-accion, y el CSS se encarga del resto
                    observer.unobserve(entry.target); // Dejar de observar una vez cargada
                }
            });
        }, { threshold: 0.1 }); // Se activa cuando el 10% de la tarjeta es visible

        document.querySelectorAll('.content-card').forEach(card => {
            contentCardObserver.observe(card);
        });
    }

    // --- Filtros de contenido ---
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Eliminar clase 'active' de todos los botones
            filterButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-dark-gold');
                btn.classList.add('bg-deep-charcoal'); // Vuelve al color inactivo
            });
            // Añadir clase 'active' al botón clicado
            button.classList.add('active', 'bg-dark-gold');
            button.classList.remove('bg-deep-charcoal'); // Quita el color inactivo

            const category = button.dataset.category;
            const filteredData = category === 'all' ? allContentData : allContentData.filter(item => item.category === category);
            loadContent(filteredData);
        });
    });
    // Activar el botón "Todos" por defecto al cargar la página
    const defaultFilterButton = document.querySelector('.filter-btn[data-category="all"]');
    if (defaultFilterButton) {
        defaultFilterButton.click();
    }


    // --- Lógica del Carrusel (Trayectoria) ---
    function initializeCarousel() {
        if (!carouselTrack || carouselContentData.length === 0) {
            // Manejar caso donde no hay carrusel o datos. Mostrar imagen estática.
            if (carouselTrack) {
                carouselTrack.innerHTML = `<div class="w-full h-full bg-cover bg-center" style="background-image: url('images/hero-bg.jpg');" role="img" aria-label="Imagen de fondo principal de Jesús Piñacué Achicué"></div>`;
                // Ocultar controles si no hay carrusel
                if (carouselPrev) carouselPrev.style.display = 'none';
                if (carouselNext) carouselNext.style.display = 'none';
                if (carouselDotsContainer) carouselDotsContainer.style.display = 'none';
            }
            return;
        }

        carouselTrack.innerHTML = '';
        carouselDotsContainer.innerHTML = '';

        carouselContentData.forEach((item, index) => {
            const slide = document.createElement('div');
            slide.className = 'w-full flex-shrink-0 h-full bg-cover bg-center rounded-lg shadow-xl overflow-hidden';
            slide.style.backgroundImage = `url('images/${item.image}')`; // Asegúrate de que las imágenes estén en /images
            slide.setAttribute('role', 'group');
            slide.setAttribute('aria-roledescription', 'slide');
            slide.setAttribute('aria-label', `${index + 1} of ${carouselContentData.length}`);

            slide.innerHTML = `
                <div class="absolute inset-0 bg-deep-charcoal bg-opacity-60 flex items-center justify-center p-6">
                    <div class="text-center text-white">
                        <h3 class="text-3xl md:text-5xl font-bold mb-4 text-shadow">${item.title}</h3>
                        <p class="text-lg md:text-xl text-shadow">${item.description}</p>
                        <p class="text-xl md:text-2xl font-semibold mt-2 text-shadow">${item.year}</p>
                    </div>
                </div>
            `;
            carouselTrack.appendChild(slide);

            const dot = document.createElement('button');
            dot.className = 'w-3 h-3 bg-gray-400 rounded-full hover:bg-dark-gold transition-colors duration-200';
            dot.setAttribute('aria-label', `Go to slide ${index + 1}`);
            dot.addEventListener('click', () => {
                goToSlide(index);
                resetAutoSlide();
            });
            carouselDotsContainer.appendChild(dot);
        });

        goToSlide(currentIndex); // Mostrar el primer slide
        startAutoSlide(); // Iniciar auto-avance
    }

    function goToSlide(index) {
        if (index >= carouselContentData.length) currentIndex = 0;
        else if (index < 0) currentIndex = carouselContentData.length - 1;
        else currentIndex = index;
        
        carouselTrack.style.transform = `translateX(-${currentIndex * 100}%)`;

        // Actualizar puntos de navegación
        carouselDotsContainer.querySelectorAll('button').forEach((dot, i) => {
            if (i === currentIndex) {
                dot.classList.add('active-dot'); // Usa la nueva clase 'active-dot'
                dot.classList.remove('bg-gray-400');
            } else {
                dot.classList.remove('active-dot');
                dot.classList.add('bg-gray-400');
            }
        });
    }

    // Funciones de navegación del carrusel
    const nextSlide = () => goToSlide(currentIndex + 1);
    const prevSlide = () => goToSlide(currentIndex - 1);

    if (carouselPrev) carouselPrev.addEventListener('click', () => { prevSlide(); resetAutoSlide(); });
    if (carouselNext) carouselNext.addEventListener('click', () => { nextSlide(); resetAutoSlide(); });

    // --- Funcionalidad de Swipe para Carrusel (Móviles) ---
    if (carouselTrack) {
        carouselTrack.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            clearInterval(autoSlideInterval); // Detener auto-avance al iniciar el swipe
        });

        carouselTrack.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const diffX = startX - endX; // Diferencia de posición
            const swipeThreshold = 50; // Mínimo de píxeles para considerar un swipe

            if (diffX > swipeThreshold) {
                // Swipe a la izquierda (next slide)
                nextSlide();
            } else if (diffX < -swipeThreshold) {
                // Swipe a la derecha (prev slide)
                prevSlide();
            }
            startAutoSlide(); // Reanudar auto-avance después del swipe
        });
    }
    
    // --- Auto-avance del Carrusel ---
    function startAutoSlide() {
        clearInterval(autoSlideInterval); // Limpiar cualquier intervalo anterior
        autoSlideInterval = setInterval(() => {
            nextSlide();
        }, 3000); // Cambia cada 3 segundos (velocidad buena para ver 3 imágenes)
    }

    function resetAutoSlide() {
        clearInterval(autoSlideInterval);
        startAutoSlide();
    }

    // --- Inicialización del Carrusel ---
    initializeCarousel();

    // --- Función para el desplazamiento suave para enlaces de anclaje ---
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // Obtener la altura del header para el offset
                const headerHeight = header ? header.offsetHeight : 0;
                window.scrollTo({
                    top: targetElement.offsetTop - headerHeight,
                    behavior: 'smooth'
                });
            }
        });
    });
});
